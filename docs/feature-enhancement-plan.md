# Network RC 功能增强方案

## 1. GPS模块集成

### 1.1 GPS配置功能
- 新增GPS配置界面
  - 串口配置（端口、波特率等）
  - GPS数据格式设置
  - 更新频率控制
- 实现GPS数据解析服务
  - NMEA协议解析
  - 经纬度坐标转换
  - 数据有效性验证

### 1.2 实时地图显示
- 集成地图组件
  - 使用Leaflet.js作为地图引擎
  - 支持离线地图缓存
  - 自定义地图样式
- 实时位置更新
  - WebSocket实时数据推送
  - 轨迹记录和回放
  - 位置标记和信息展示

## 2. Cloudflare Zero Trust Tunnels集成

### 2.1 移除FRP功能
- 清理FRP相关代码和配置
- 迁移现有连接配置

### 2.2 实现Cloudflare Tunnel
- 集成Cloudflare API
  - 隧道创建和管理
  - 域名解析配置
  - 访问策略设置
- 提供配置界面
  - Token配置
  - 隧道状态监控
  - 流量统计显示

## 3. 4G网络优化

### 3.1 视频传输优化
- 实现自适应码率
  - 网络状况检测
  - 动态调整分辨率
  - 帧率自适应控制
- 引入WebRTC优化
  - ICE优化配置
  - TURN服务器支持
  - 丢包重传机制

### 3.2 控制延迟优化
- 控制指令优先级
  - 关键指令加速
  - 指令合并处理
- 网络状态监控
  - RTT检测
  - 链路质量评估
  - 自动重连机制

## 4. 日志系统实现
### 4.1 日志分类与等级

#### 4.1.1 功能模块分类

- 控制器日志
  - 控制指令记录（方向、速度、特殊功能）
  - 设备状态变化（在线、离线、异常）
  - 操作事件（启动、停止、紧急制动）
  - 异常操作警告（越界、超速）

- 视频模块日志
  - 视频流状态（启动、停止、重连）
  - 编码参数变更（分辨率、码率、帧率）
  - 画面质量监控（延迟、丢帧率）
  - WebRTC连接状态

- 音频模块日志
  - 音频流状态（启动、停止、重连）
  - 音量控制记录（调节、静音）
  - 通话质量数据（延迟、丢包率）
  - 音频设备状态

- GPS模块日志
  - 位置数据记录（经纬度、海拔、速度）
  - 信号质量信息（卫星数量、信号强度）
  - 异常定位警告（信号丢失、定位漂移）
  - 轨迹记录事件

- 网络连接日志
  - Cloudflare Tunnel状态
  - WebRTC连接质量
  - 网络性能指标（延迟、带宽、丢包率）
  - 连接异常记录

- 系统运行日志
  - 系统事件（启动、关闭、重启）
  - 资源使用状况（CPU、内存、存储）
  - 系统异常记录
  - 配置变更记录

#### 4.1.2 日志等级定义

- FATAL
  - 系统崩溃或无法恢复的错误
  - 硬件严重故障（如摄像头损坏）
  - 关键服务完全不可用
  - 需要立即人工干预

- ERROR
  - 功能模块异常（但系统仍可运行）
  - 操作失败（如控制指令执行失败）
  - 网络连接中断
  - 配置加载失败

- WARN
  - 性能显著下降（高延迟、高丢包率）
  - 配置参数异常但使用默认值
  - GPS信号弱或不稳定
  - 设备状态异常但可自动恢复

- INFO
  - 正常操作记录（控制指令、配置修改）
  - 设备状态变更（上线、离线）
  - 系统事件（启动、关闭）
  - 重要数据更新

- DEBUG
  - 详细的操作流程信息
  - 性能监控数据
  - 网络连接详细状态
  - 设备参数详细信息

- TRACE
  - 最详细的调试信息
  - 数据流跟踪记录
  - 性能分析详细数据
  - 开发测试信息

### 4.2 日志存储设计

#### 4.2.1 数据库结构

- 日志主表
  - 日志ID（主键，自增）
  - 时间戳（精确到毫秒）
  - 日志等级（FATAL/ERROR/WARN/INFO/DEBUG/TRACE）
  - 模块分类（控制器/视频/音频/GPS/网络/系统）
  - 事件类型（自定义枚举）
  - 日志内容（文本描述）
  - 相关数据（JSON格式，包含详细参数）
  - 设备标识（用于多设备区分）

- 性能指标表
  - 指标ID（主键，自增）
  - 时间戳（精确到秒）
  - 模块名称
  - 指标类型（CPU/内存/网络/GPS等）
  - 指标值
  - 单位
  - 阈值设定
  - 设备标识

#### 4.2.2 存储策略

- 日志轮转
  - 按大小分割（默认单文件100MB）
  - 按时间分割（每天一个文件）
  - 保留策略（默认保留30天）
  - 自动清理机制

- 数据压缩
  - 实时压缩（gzip）
  - 定期归档（tar）
  - 压缩文件命名规范
  - 解压恢复机制

### 4.3 日志查询功能

#### 4.3.1 查询条件

- 时间范围查询
  - 精确时间点
  - 时间段选择
  - 相对时间范围（最近1小时/24小时/7天）
  - 自定义时间格式

- 模块筛选
  - 单模块查询
  - 多模块组合
  - 关联模块分析
  - 自定义模块组

- 等级过滤
  - 单一等级
  - 等级范围
  - 多等级组合
  - 等级优先级

- 关键字搜索
  - 全文检索
  - 字段匹配
  - 正则表达式
  - 模糊匹配

#### 4.3.2 查询接口

- RESTful API
  - GET /logs/query（基础查询）
  - POST /logs/search（高级搜索）
  - GET /logs/stats（统计数据）
  - GET /logs/export（数据导出）

- WebSocket实时推送
  - 实时日志流
  - 告警推送
  - 状态更新
  - 性能指标

#### 4.3.3 数据展示

- 列表视图
  - 分页加载（默认20条/页）
  - 多维度排序
  - 自定义过滤器
  - 列显示配置

- 统计分析
  - 错误率统计
  - 模块健康度
  - 性能趋势图
  - 自定义报表

- 导出功能
  - JSON格式
  - CSV格式
  - 日志打包下载
  - 自定义导出字段

### 4.4 告警机制

#### 4.4.1 告警规则

- 错误阈值
  - 错误数量（单位时间内）
  - 错误频率（百分比）
  - 错误级别（可配置）
  - 持续时间

- 性能阈值
  - CPU使用率（>80%）
  - 内存占用（>85%）
  - 响应时间（>1000ms）
  - 存储空间（>90%）

- 自定义规则
  - 组合条件
  - 时间窗口
  - 触发条件
  - 重置机制

#### 4.4.2 通知方式

- 界面提醒
  - 状态图标
  - 消息弹窗
  - 声音提醒
  - 颜色标识

- 外部通知
  - Email通知
  - Webhook集成
  - 自定义通知
  - 通知级别控制

## 5. Bookworm兼容性

### 5.1 系统依赖检查
- Node.js版本兼容性
- 系统库依赖更新
- 硬件驱动兼容性

### 5.2 适配方案
- 更新包管理配置
- 调整系统调用
- 优化启动脚本

## 6. 安全性增强

### 6.1 身份认证
- 实现JWT认证
- HTTPS强制开启
- 会话管理优化

### 6.2 访问控制
- API访问限制
- 权限系统实现
- 敏感数据加密

## 7. 代码优化

### 7.1 性能优化
- 异步处理优化
- 内存管理优化
- 并发控制改进

### 7.2 代码重构
- 模块化改进
- 错误处理统一
- 代码风格规范

## 实施时间规划

1. GPS模块集成 - 2周
2. Cloudflare Tunnel实现 - 1周
3. 4G网络优化 - 2周
4. 日志系统实现 - 1周
5. Bookworm兼容性适配 - 1周
6. 安全性增强 - 1周
7. 代码优化 - 2周

总计预期时间：10周

## 技术栈规划

### 后端技术
- Node.js 18+
- WebSocket
- WebRTC
- SQLite（日志存储）

### 前端技术
- React 18
- Material-UI v5
- Leaflet.js
- WebRTC API

### 工具和服务
- Cloudflare Zero Trust
- GPS NMEA解析库
- Jest（测试框架）
- ESLint（代码规范）